<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2×2 即時折線圖</title>
  <!-- 引入 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* 簡單的 2×2 排版示範 */
    .row {
      display: flex;
      flex-direction: row;
      margin-bottom: 20px; /* 每行之間留些空白 */
    }
    .chart-container {
      flex: 1;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h1>Flask SSE - 2×2 折線圖</h1>

  <!-- 第一行: 兩個圖 -->
  <div class="row">
    <div class="chart-container">
      <h3>Chart 1</h3>
      <canvas id="myChart1" width="400" height="300"></canvas>
    </div>
    <div class="chart-container">
      <h3>Chart 2</h3>
      <canvas id="myChart2" width="400" height="300"></canvas>
    </div>
  </div>

  <!-- 第二行: 兩個圖 -->
  <div class="row">
    <div class="chart-container">
      <h3>Chart 3</h3>
      <canvas id="myChart3" width="400" height="300"></canvas>
    </div>
    <div class="chart-container">
      <h3>Chart 4</h3>
      <canvas id="myChart4" width="400" height="300"></canvas>
    </div>
  </div>

  <script>
    //----------------------------------------------------------------
    // 1. 從後端拿到四張圖的歷史資料
    const initialData1 = {{ history1|tojson }};
    const initialData2 = {{ history2|tojson }};
    const initialData3 = {{ history3|tojson }};
    const initialData4 = {{ history4|tojson }};

    //----------------------------------------------------------------
    // 2. 建立 Chart 物件的函式（避免重複）
    function createChart(ctxId, initData, chartLabel) {
      let ctx = document.getElementById(ctxId).getContext('2d');
      let labels = initData.map((_, i) => i + 1);
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: chartLabel,
            data: initData,
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            x: {
              ticks: { autoSkip: true, maxTicksLimit: 10 }
            },
            y: { beginAtZero: true }
          }
        }
      });
    }

    //----------------------------------------------------------------
    // 3. 初始化四張圖
    let chart1 = createChart('myChart1', initialData1, 'Data 1');
    let chart2 = createChart('myChart2', initialData2, 'Data 2');
    let chart3 = createChart('myChart3', initialData3, 'Data 3');
    let chart4 = createChart('myChart4', initialData4, 'Data 4');

    //----------------------------------------------------------------
    // 4. SSE 更新函式
    function setupSSE(url, chart) {
      const source = new EventSource(url);
      source.onmessage = function(event) {
        let newValue = parseFloat(event.data);
        let nextIndex = chart.data.labels.length + 1;
        chart.data.labels.push(nextIndex);
        chart.data.datasets[0].data.push(newValue);
        chart.update();
      };
    }

    // 連接四個不同的 SSE 路由
    setupSSE("/chart_value_1", chart1);
    setupSSE("/chart_value_2", chart2);
    setupSSE("/chart_value_3", chart3);
    setupSSE("/chart_value_4", chart4);

  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>保留歷史資料的即時折線圖</title>
  <!-- 引入 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Flask SSE 即時折線圖 (保留歷史)</h1>
  <canvas id="myChart"></canvas>

  <script>
    // 從後端接收的歷史資料 (以 JSON 傳遞)
    // Flask模板語法：{{ history|tojson }} 可以將後端的 Python list 轉為前端可用的 JSON
    const initialData = {{ history | tojson }};

    // Chart.js 設定
    let ctx = document.getElementById('myChart').getContext('2d');

    // 準備 X 軸標籤與對應值
    // 這裡簡單假設 X 軸就是 1,2,3,... 順序即可，
    // 也可以透過其它方式（例如時間字串）呈現。
    let labels = initialData.map((val, idx) => idx + 1);
    let dataValues = initialData;

    let chartData = {
      labels: labels,           // X軸：歷史所有序號
      datasets: [{
        label: 'Real-time Value',
        data: dataValues,       // Y軸：歷史所有數值
        borderWidth: 1
      }]
    };

    let myChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        scales: {
          x: {
            ticks: {
              autoSkip: true,
              maxTicksLimit: 10
            }
          },
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // 與 SSE 路由(/chart_value) 建立連線
    const evtSource = new EventSource("/chart_value");

    evtSource.onmessage = function(event) {
      // 從 SSE 收到的新值
      let newValue = parseInt(event.data);

      // 將新值加入 chart.js 的資料
      myChart.data.labels.push(myChart.data.labels.length + 1);  // X軸序號 +1
      myChart.data.datasets[0].data.push(newValue);

      // 更新圖表
      myChart.update();
    };
  </script>
</body>
</html>
